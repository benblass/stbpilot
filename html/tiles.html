<div id="map_container"></div>
<script type="text/javascript">

	var display_options = {{options.flight_area.display_options}};
	var flight_zones = {{options.flight_area.flight_zones}};
	var vehicle_location = {"type": "Point", "coordinates": {{options.vehicle_location}}};

// Initiate the map
	var map = L.map('map_container').setView(display_options.center_coords,display_options.zoom_level);

	var tilesPath = '/static/maptiles/' + "{{options.flight_area.name}}" + '/{z}/{x}/{y}.png';

	L.tileLayer(tilesPath , {maxZoom: display_options.maxZoom, minZoom: display_options.minZoom}).addTo(map);

	var zonesLayer = L.geoJson(flight_zones, {
			style: function(feature) {
				var style = {};
				style.color = feature.properties.color;
				style.dashArray = '10';
				style.weight = '2';
				return style;
			},
			onEachFeature: onEachFeature
		});

	map.addLayer(zonesLayer);

//Initiate the drone marker
	var droneIcon = L.icon({
		iconUrl: '/static/img/droneicon.png',
		iconSize: [32,32],
		iconAnchor: [16,16]
	});

	var droneLayer = L.geoJson(vehicle_location, {
				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {icon: droneIcon});
						}
		}).addTo(map);

//Initiate the control box

var info = L.control();

info.onAdd = function(map) {
	this._div = L.DomUtil.create('div', 'info');
	this.update();
	return this._div;
}

info.update = function (properties) {
	if (properties) {
		this._div.innerHTML = '<h4> Zone de Vol </h4>' + (properties ? '<b>Secteur "' + properties.flname + '"</b>' : '{{options.flight_area.name}}') + (properties.selected ? '<br><b>Selected</b>' : '');
	}
}

info.addTo(map);

//Update function
	
	function update_marker(data) {
		vehicle_location = {"type": "Point", "coordinates": data.position};
		map.removeLayer(droneLayer);
		droneLayer = L.geoJson(vehicle_location, {
				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {icon: droneIcon});
						}
		}).addTo(map);
	}

//User Interation functions

	function highlightZone(e) {
		var layer = e.target;
		info.update(layer.feature.properties);
		layer.setStyle({
			weight: 5,
			dashArray: '',
			fillOpacity: 0.8
		});
	}
	function resetHighlight(e) {
		zonesLayer.resetStyle(e.target);
		info.update();
	}

	function zoomToFeature(e) {
		zonebounds = e.target.getBounds();
		map.fitBounds(zonebounds.extend(droneLayer.getBounds()));
	}

	function blockEventListeners(e) {
		zonesLayer.eachLayer(function(layer) {
			layer.off({
				mouseover: highlightZone,
				mouseout: resetHighlight,
				click: clickZone
			});
		})
			e.target.on('click', clickZone);
	}

	function resetEventListeners(e) {
		zonesLayer.eachLayer(function(layer) {
			layer.on({
				mouseover: highlightZone,
				mouseout: resetHighlight,
				click: clickZone
			});
		});
	}

	function clickZone(e) {
		if (e.target.feature.properties.selected){

			e.target.feature.properties.selected = 0;
			resetEventListeners(e);
			zone_unselected();
		
		}else{
		
			e.target.feature.properties.selected = 1;

			blockEventListeners(e);

			zoomToFeature(e);
			info.update(e.target.feature.properties);
			zone_selected(e.target.feature.properties.index);
		}
	}

	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightZone,
			mouseout: resetHighlight,
			click: clickZone
		});
	}
</script>
